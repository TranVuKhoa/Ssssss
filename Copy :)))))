local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local Settings = {
    HitboxSize = Vector3.new(15, 15, 15),
    CheckTeam = true,
}

local char, hrp, hum

local function UpdateCache()
    char = LocalPlayer.Character
    if not char then return end
    hrp = char:FindFirstChild("HumanoidRootPart")
    hum = char:FindFirstChildOfClass("Humanoid")
end

LocalPlayer.CharacterAdded:Connect(function(c)
    char = c
    c:WaitForChild("HumanoidRootPart")
    UpdateCache()
end)
UpdateCache()

pcall(function()
    local mt = getrawmetatable(game)
    local old = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        if getnamecallmethod():lower() == "kick" then return nil end
        return old(self, ...)
    end)
    setreadonly(mt, true)
end)

pcall(function()
    game:GetService("VirtualUser")
    LocalPlayer.Idled:Connect(function()
        pcall(function()
            game:GetService("VirtualUser"):Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        end)
    end)
end)

local function IsInSafeZone(p)
    local c = p.Character
    if not c then return false end
    local head = c:FindFirstChild("Head")
    if head and head:FindFirstChild("PVPDisabledIcon") then return true end
    if c:FindFirstChildOfClass("ForceField") then return true end
    if c:FindFirstChild("SafeZone") then return true end
    if c:FindFirstChild("IsInSafeZone") then return true end
    return false
end

local function IsValidTarget(p)
    if p == LocalPlayer then return false end
    local c = p.Character
    if not c then return false end
    local h  = c:FindFirstChild("HumanoidRootPart")
    local hm = c:FindFirstChildOfClass("Humanoid")
    if not h or not hm or hm.Health <= 0 then return false end
    if Settings.CheckTeam and p.Team == LocalPlayer.Team then return false end
    if IsInSafeZone(p) then return false end
    return true
end

-- HITBOX EXPAND
task.spawn(function()
    while task.wait(0) do
        pcall(function()
            for _, p in Players:GetPlayers() do
                if IsValidTarget(p) then
                    local root = p.Character:FindFirstChild("HumanoidRootPart")
                    if root then root.Size = Settings.HitboxSize end
                end
            end
            for _, model in pairs(workspace:GetDescendants()) do
                if model:IsA("Humanoid") and model.Health > 0 and model.Parent ~= char then
                    local root = model.Parent:FindFirstChild("HumanoidRootPart")
                    if root then root.Size = Settings.HitboxSize end
                end
            end
        end)
    end
end)

-- HITBOX VISUAL
local function ShowHitbox(model)
    pcall(function()
        if not model then return end
        local root = model:FindFirstChild("HumanoidRootPart")
                  or model:FindFirstChild("Torso")
                  or model:FindFirstChild("Root")
        if not root then return end
        if root:FindFirstChild("HitboxVis") then return end
        root.Size = Settings.HitboxSize
        local box = Instance.new("SelectionBox")
        box.Name = "HitboxVis"
        box.Color3 = Players:GetPlayerFromCharacter(model) and Color3.fromRGB(255,0,0) or Color3.fromRGB(0,255,0)
        box.LineThickness = 0.05
        box.Adornee = root
        box.Parent = root
    end)
end

task.spawn(function()
    for _, p in Players:GetPlayers() do
        if p ~= LocalPlayer and p.Character then ShowHitbox(p.Character) end
        p.CharacterAdded:Connect(function(c) task.wait(0.5); ShowHitbox(c) end)
    end
    Players.PlayerAdded:Connect(function(p)
        p.CharacterAdded:Connect(function(c) task.wait(0.5); ShowHitbox(c) end)
    end)
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Humanoid") and v.Parent ~= LocalPlayer.Character then
            ShowHitbox(v.Parent)
        end
    end
    workspace.DescendantAdded:Connect(function(v)
        if v:IsA("Humanoid") and v.Parent ~= LocalPlayer.Character then
            task.wait(0.5)
            ShowHitbox(v.Parent)
        end
    end)
end)

-- ANTI STUN
task.spawn(function()
    while task.wait(0) do
        pcall(function()
            if not hum then UpdateCache(); return end
            if hum.Sit then hum.Sit = false end
            hum.WalkSpeed = 24
            hum.JumpPower = 50
        end)
    end
end)

-- FIX LAG
task.spawn(function()
    local function Opt(v)
        pcall(function()
            if v:IsA("BasePart") then
                v.Material = Enum.Material.SmoothPlastic
                v.CastShadow = false
            elseif v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter")
                or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
                v:Destroy()
            end
        end)
    end
    for _, v in game:GetDescendants() do Opt(v) end
    game.DescendantAdded:Connect(Opt)
    local L = game:GetService("Lighting")
    L.GlobalShadows = false
    L.FogEnd = 9e9
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
end)
